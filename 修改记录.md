# 修改记录（编辑中）

#### UpdateTime:2024.10.6

- 申请时可填入用途

> 日志有点问题，目前会把多个物品申请分为多条日志

- 从电子表格中导入物品数据

- 恢复归还操作（仍使用按键）

- docker镜像(redis,依赖包)

**TODO:**

- 优化注释，编写文档，准备交接

#### UpdateTime:2024.10.5

- ~~引入带异步的flask包~~

- ~~将线程池替换为异步~~

- 使用`Celery`搭配`Redis`创建后台任务,以便对`card.action.trigger`事件快速响应

- 限制每个用户的请求数,数据存储改用Redis

- 可以勾选待申请的物品

**TODO:**

- 优化注释，编写文档，准备交接

- 从电子表格中导入物品数据

- 申请时可填入用途

> 两个想法

> 1. 通过勾选器勾选需要的物品,已选中的物品跟着卡片一起更新;按钮用于展示物品详细信息

> 2. 通过按钮申领,表单用于设定用途;勾选器无意义

> 先尝试使用`方案1`

- 恢复还原操作（仍使用按键）

#### UpdateTime:2024.10.3/4

- 搜索框

> `api_mysql`搜索添加了模糊搜索

- 优化卡片操作请求的处理逻辑

- 优化消息卡片的构建

- 消息卡片的请求改为异步处理

- 限制每个用户的请求数

> e.g.:狂按“物资查询”按钮，会弹出一堆信息卡片，但正常情况下应该在上一次响应完成后再接着响应(撤回旧卡片再添加新卡片)

- 对飞书api的请求加入自动重试

> 未测试

**TODO:**

- 申请时可填入用途

#### UpdateTime:2024.9.29

- 把已处理请求的event_id存储在mysql数据库中

> 每隔12小时清理一次

- 将所有能丢入多线程的动作丢入多线程

> 使用`concurrent.futures.ThreadPoolExecutor`，可以更好地管理线程池，避免频繁创建和销毁线程。

- 使用`dbutils`创建连接池

- 优化了`api_mysql.py`

- 优化了下日志

- 优化下注释

**TODO:**

- 加入搜索框

- 申请时可填入用途

- 对外部 API 调用实现重试机制，以应对临时的网络故障。

#### UpdateTime:2024.9.28

- 重新把json卡片提上计划

> 文档里说卡片大小不得超过30kb，但实测发送45k的数据也能生成卡片？

> 进行了一个简单的极限值测试，大概<214kb的数据都能发送

- 暂时使用`threading`实现对请求的先响应后处理

- 暂时在内存里存储已处理请求的token，并设置每隔3小时重启一次程序

**TODO**

- 队内算法组提醒说可以换`fast-api`代替`Flask`以处理并发请求

- 给卡片添加表单和勾选功能

- 把已处理请求的token存储在mysql数据库中

#### UpdateTime:2024.9.26

- ~~引入`gunicorn`代替flask内置wsgi服务端，以处理并发请求~~

> ~~更新了`requirements.txt`，需要重新构建镜像~~

> 失败，尝试了gunicorn和uwsgi都无法工作，看了眼航的开源是直接使用flask的，就这样放着吧（）

- ~~成员信息从通讯录获得改成从指定群组获得~~没必要，修改了下用来生成md5的字段，速度快多了

- 整理一下TODO：

**TODO:**

- 设置小程序，实现扫码取还增改物品

- 采用异步方法，防止消息堵塞

- 批量删除

- ~~分页显示~~

- ~~使用json格式发送小程序卡片，以创造更个性化的卡片~~

- 使用 `asyncio` 和 `aiohttp` 库来实现并发HTTP请求

- 处理数据库操作时，使用连接池

- ...

#### UpdateTime:2024.9.25(Ver 0.0.2(test))

- 飞书审批功能在凌晨2点失灵过一段时间

- ~~使用json格式发送小程序卡片，以创造更个性化的卡片~~

- 修改信息卡片内容，加入“主页”和“个人”按钮

> 实际测试中json格式卡片不存在循环容器,会导致卡片体积太大,暂时砍掉

- 数据库~~定时备份&~~手动/save同步至云文档内

- 物资仓库-添加-个人持有物品页

- 修复重新从电子表格获取物资时，物资数仅+1的BUG

**TODO:**

- 使用 `asyncio` 和 `aiohttp` 库来实现并发HTTP请求

- 处理数据库操作时，使用连接池

- 成员信息从通讯录获得改成从指定群组获得

#### UpdateTime:2024.9.24

- 取消了对HTTP请求相应的状态码判断

> 因调用飞书API接口错误时会传回非200状态码，故不采用状态码判断

- 往`members表`中添加`列card_message_id`和`列card_message_create_time`

> 用于记录消息卡片信息，确保会话中只有一个消息卡片

- 对所有飞书api调用接口添加异常捕获，确保初始化进程出异常时不会堵塞进程

- 目前用户界面只能存在一个活动的消息卡片，其余消息卡片会在操作后弹出警告消息然后自动撤回

- 统一了物资仓库api的参数名

- 修复命令行，现在它大概稳定了

**done**

- 归还功能

**Todo:**

- 设置小程序，实现扫码取还增改物品

- ~~采用异步方法，防止消息堵塞~~

- **数据库定时备份&同步至云文档内**

- 批量删除

- 分页显示

- **使用json格式发送小程序卡片，以创造更个性化的卡片**

- ...

#### UpdateTime:2024.9.23 (Ver 0.0.1(test))

- 适配了下V1事件

> 因为审批状态变更事件目前只有V1版本

- ~~赋能~~使能通过卡片申请物品操作

- 添加/search命令

**目前实现的功能：**

- 通过信息卡片进行申请物资操作

- 实现增删功能

> 发送消息

**Todo:**

- 设置小程序，实现扫码取还增改物品

- ~~采用异步方法，防止消息堵塞~~

- 数据库定时备份&同步至云文档内

- 批量删除

- 分页显示

- add:使用json格式发送小程序卡片，以创造更个性化的卡片

- ...

#### UpdateTime:2024.9.22

- 实现增删功能

- 完善api实现

- 调整logs表列定义

- 管理管理员权限

> {'op {{@user_name}}':<{margin}} \t给予管理员权限

> {'deop {{@user_name}}':<{margin}} \t取消管理员权限

> {'lsop {{@user_name}}':<{margin}} \t列出管理员列表

**目前实现的功能：**

- 通过信息卡片进行申请物资操作

- 实现增删功能

> 发送消息/信息卡片/小程序 任选，先实现功能再优化

**Todo:**

- ~~调用审批接口处理申请物资请求~~

- 设置小程序，实现扫码取还增改物品

- ~~采用异步方法，防止消息堵塞~~

- add:添加/search命令

- add:数据库定时备份&同步至云文档内

- add:批量删除

- add:分页显示

- ...


#### UpdateTime:2024.9.21

- 优化`从电子表格初始化物资`和`从通讯录中获取成员列表`功能，加入MD5校验（存在`表logs`内，避免每次重启服务端都要遍历一边数据，节省资源

- 调整`table`的设置

- 优化消息卡片，两张卡片json格式均在`./card_example.json`

- 优化目录结构(除`server.py`和`init.py`，其余脚本文件存入`./scripts`)

- 优化api接口实现

- Sheet的信息从`.env`转移到`settings.json`

**目前实现的功能：**

- 通过机器人菜单可唤出物资仓库，通过消息卡片检查物资信息

- 启动时自动同步云空间内电子表格数据

**Todo:**

- done~~通过信息卡片进行申请物资操作~~

- ~~调用审批接口处理申请物资请求~~

- done~~实现增删功能~~

> ~~发送消息/信息卡片/小程序 任选，先实现功能再优化~~

- ~~设置小程序，实现扫码取还增改物品~~

- ~~采用异步方法，防止消息堵塞~~

- ...

#### UpdateTime:2024.9.20

- 加入了从`通讯录`中获取成员列表的功能

- 加入了从`电子表格`中初始化物资信息的功能，`init.py`中的设置初值功能已注释

> **Tips：*使用此功能请记得在`.env`文件中配置存储物资信息的电子表格的

> `SHEET_TOKEN`to`ITEM_SHEET_TOKEN`

> 什么是`SHEET_TOKEN`请查找飞书的开发者文档。

> 关于获取`SHEET_TOKEN`，我采用的办法是在电脑端飞书-云文档-侧栏（如没有请单机左上角按钮`三`）-我的文档库-找到你想获取TOKEN的文档-右键-分享-复制链接

> 此时的链接就是开发者文档中`.../sheets/...`的格式了

> 对于电子表格中的物资信息有如下规则：

> - 第一行可自定义

> - 从第二行开始，各列有自己的含义：

> - A:类型， B:名称， C:总数， D:损坏数（不可用）

> - 从第二行到最后一行始终保持该规律，其中AB列不能存在空值

> TODO 通过搜索云空间自行找到物资储物表

以上功能均需要开启对应权限

- 偷懒只写了通过`user_id`进行各种操作，如需使用`open_id`等其他类型区分用户，请自己添加

- 修改了机器人菜单,目前菜单事件仅有`物资查询`-`custom_menu.inspect.items`

- 修改了飞书卡片-保存至`./card_example.json`

> 飞书卡片在旧版本飞书中存在不兼容情况（具体表现为左侧按钮被遮住），需要更新至 `V6.8及以上版本`